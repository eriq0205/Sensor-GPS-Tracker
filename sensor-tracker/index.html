<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackEye Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f9f7fb; margin: 0; padding: 0; }
        header { background-color: #7e57c2; color: white; padding: 10px; text-align: center; font-size: 22px; font-weight: bold; }
        .top-container { display: flex; justify-content: space-between; padding: 10px; }
        .box { flex: 1; margin: 5px; background: #ffffff; border-radius: 8px; box-shadow: 0 0 10px rgba(90,0,150,0.1); display: flex; flex-direction: column; }
        .box h3 { background-color: #b085f5; color: white; margin: 0; padding: 5px; text-align: center; border-radius: 8px 8px 0 0; font-size: 16px; }
        #map { width: 100%; height: 250px; }
        canvas { width: 100%; height: 250px; }
        img { width: 100%; height: 250px; object-fit: cover; border-radius: 0 0 8px 8px; }
        #controls { text-align: center; margin: 10px 0; }
        #controls button { background-color: #7e57c2; color: white; border: none; padding: 8px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer; }
        #controls button:hover { background-color: #5e35b1; }
        table { width: 98%; margin: 0 auto 15px; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        thead { background-color: #7e57c2; color: white; }
        th, td { padding: 6px 10px; border-bottom: 1px solid #eee; text-align: center; }
        tbody tr:nth-child(even) { background-color: #f3eaff; }
        tbody tr:hover { background-color: #e0d4ff; }
    </style>
</head>
<body>
<header>TrackEye Dashboard</header>
<div class="top-container">
    <div class="box"><h3>Map</h3><div id="map"></div></div>
    <div class="box"><h3>Sensor Status</h3><canvas id="voltageChart"></canvas></div>
    <div class="box"><h3>Webcam</h3><img id="webcam"></div>
</div>
<div id="controls">
    <button onclick="startSystem()">Start</button>
    <button onclick="stopSystem()">Stop</button>
    <button onclick="resetSystem()">Reset Data</button>
</div>
<table>
    <thead>
        <tr><th>Timestamp</th><th>Latitude</th><th>Longitude</th><th>Voltage (V)</th><th>Status</th></tr>
    </thead>
    <tbody id="data-log"></tbody>
</table>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let running=false,fetchInterval=null;
const map=L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// Multiple markers storage
let markers=[];

// Chart.js with timestamp
const ctx=document.getElementById('voltageChart').getContext('2d');
const voltageChart=new Chart(ctx,{
    type:'line',
    data:{datasets:[{label:'Voltage (V)',borderColor:'#7e57c2',backgroundColor:'#d1c4e9',data:[],fill:true,tension:0.3}]},
    options:{
        responsive:true,animation:false,
        scales:{
            x:{type:'time',time:{unit:'second',tooltipFormat:'HH:mm:ss',displayFormats:{second:'HH:mm:ss'}},title:{display:true,text:'Time'}},
            y:{beginAtZero:true,title:{display:true,text:'Voltage (V)'}}
        }
    }
});

function startSystem(){
    running=true;
    document.getElementById('webcam').src="http://172.20.10.2:5000/video_feed";
    fetchInterval=setInterval(fetchData,100); //10Hz
    fetch('control.php?action=start');
}

function stopSystem(){
    running=false;
    clearInterval(fetchInterval);
    document.getElementById('webcam').src="";
    fetch('control.php?action=stop');
}

function resetSystem(){
    stopSystem();
    document.getElementById('data-log').innerHTML="";
    voltageChart.data.datasets[0].data=[];
    voltageChart.update();
    markers.forEach(m=>map.removeLayer(m));
    markers=[];
    fetch('reset_data.php');
}

async function fetchData(){
    if(!running)return;
    const response=await fetch('fetch_data.php');
    const data=await response.json();

    // Add marker
    const color=(data.status==="DEFECT")?'red':'green';
    const marker=L.circleMarker([data.lat,data.lng],{radius:6,color:color}).addTo(map);
    markers.push(marker);
    map.setView([data.lat,data.lng],18);

    // Update chart
    voltageChart.data.datasets[0].data.push({x:new Date(data.timestamp),y:parseFloat(data.voltage)});
    if(voltageChart.data.datasets[0].data.length>200)voltageChart.data.datasets[0].data.shift();
    voltageChart.update();

    // Update log (latest first)
    const logBody=document.getElementById('data-log');
    const newRow=`<tr><td>${data.timestamp}</td><td>${data.lat}</td><td>${data.lng}</td><td>${data.voltage}</td><td>${data.status}</td></tr>`;
    logBody.innerHTML=newRow+logBody.innerHTML;
}
</script>
</body>
</html>
